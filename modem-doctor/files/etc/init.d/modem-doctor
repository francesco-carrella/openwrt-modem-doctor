#!/bin/sh /etc/rc.common
# modem-doctor init script â€” procd managed
#
# Copyright (c) 2026 modem-doctor contributors
# Licensed under Apache-2.0

USE_PROCD=1

START=99
STOP=01

start_service() {
	config_load modem-doctor

	local enabled
	config_get enabled main enabled 0
	[ "$enabled" = "1" ] || return 0

	# Run one-shot boot fixes
	/usr/bin/modem-doctor-setup.sh

	# Start watchdog daemon
	procd_open_instance watchdog
	procd_set_param command /usr/bin/modem-doctor.sh
	procd_set_param stdout 0
	procd_set_param stderr 1
	# respawn: threshold=3600s, timeout=5s, retry=5
	procd_set_param respawn 3600 5 5
	procd_close_instance
}

stop_service() {
	# Clean up state files
	rm -f /tmp/modem-doctor-state /tmp/modem-doctor-state.tmp
}

service_triggers() {
	PROCD_RELOAD_DELAY=2000
	procd_add_reload_trigger "modem-doctor"
}

reload_service() {
	stop
	start
}
